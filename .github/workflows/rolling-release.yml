---
name: Rolling Release

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-x64
            runner: ubuntu-latest
            shell: bash
            cmake_arch: x86_64
          - name: ubuntu-arm64
            runner: ubuntu-24.04-arm
            shell: bash
            cmake_arch: aarch64
          - name: macos-x64
            runner: macos-13
            shell: bash
            cmake_arch: x86_64
          - name: macos-arm64
            runner: macos-14
            shell: bash
            cmake_arch: arm64
          - name: windows-x64
            runner: windows-latest
            shell: powershell
            cmake_arch: x64
          - name: windows-arm64
            runner: windows-11-arm
            shell: powershell
            cmake_arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check recent releases
        id: check_releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          SINCE="$(python3 -c 'from datetime import datetime, timedelta; print((datetime.utcnow() - timedelta(hours=24)).strftime("%Y-%m-%dT%H:%M:%SZ"))')"
          COUNT=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" \
            | jq "[.[] | select(.created_at >= \"$SINCE\")] | length")
          echo "releases_last24h=$COUNT" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -ge 2 ]; then
            echo "skip_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip_build=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip build when release limit reached
        if: steps.check_releases.outputs.skip_build == 'true'
        run: |
          echo 'Skipping build: daily release threshold reached.'

      - name: Set up C++ build environment
        if: steps.check_releases.outputs.skip_build != 'true'
        uses: aminya/setup-cpp@v1

      - name: Enable ccache
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os != 'Windows'
        uses: hendrikmuhs/ccache-action@v1.2.19
        with:
          key: ${{ runner.os }}-${{ matrix.name }}-rolling-ccache-${{ github.event.workflow_run.head_sha }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.name }}-rolling-ccache-

      - name: Cache CMake dependencies
        if: steps.check_releases.outputs.skip_build != 'true'
        uses: actions/cache@v4
        with:
          path: build/**/_deps
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'cmake/**', '**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      - name: Configure (Linux/macOS)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os != 'Windows'
        shell: bash
        env:
          CMAKE_CXX_COMPILER_LAUNCHER: ccache
        run: |
          cmake --preset rolling -DCODEX_FORCE_NO_NSEC=ON
      - name: Build (Linux/macOS)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os != 'Windows'
        shell: bash
        run: cmake --build --preset rolling --parallel
      - name: Run tests (Linux/macOS)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="build/rolling/$(uname)-$(uname -m)"
          ctest --test-dir "$BIN_DIR" -C RelWithDebInfo --output-on-failure --parallel
      - name: Configure (Windows)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os == 'Windows'
        shell: powershell
        run: |
          $arch = '${{ matrix.cmake_arch }}'
          $generatorArgs = if ($arch -eq 'arm64') { '-A ARM64' } else { '-A x64' }
          cmake -S . -B build -G "Visual Studio 17 2022" $generatorArgs -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCODEX_FORCE_NO_NSEC=ON -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON -DCMAKE_INSTALL_RPATH_USE_LINK_PATH=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON
      - name: Build (Windows)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os == 'Windows'
        shell: powershell
        run: cmake --build build --config RelWithDebInfo --parallel
      - name: Run tests (Windows)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os == 'Windows'
        shell: powershell
        run: ctest --test-dir build -C RelWithDebInfo --output-on-failure || true
      - name: Stage artifact (Linux/macOS)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="build/rolling/$(uname)-$(uname -m)"
          DEST="dist/${{ matrix.name }}"
          mkdir -p "$DEST"
          install -m 755 "$BIN_DIR/autogitpull" "$DEST/autogitpull"
          install -m 644 readme.md "$DEST/README.md"
          install -m 644 license.md "$DEST/LICENSE.md"
      - name: Stage artifact (Windows)
        if: steps.check_releases.outputs.skip_build != 'true' && runner.os == 'Windows'
        shell: powershell
        run: |
          $dest = "dist/${{ matrix.name }}"
          New-Item -ItemType Directory -Force -Path $dest | Out-Null
          Copy-Item -Path "build/RelWithDebInfo/autogitpull.exe" -Destination (Join-Path $dest 'autogitpull.exe') -Force
          Copy-Item -Path readme.md -Destination (Join-Path $dest 'README.md') -Force
          Copy-Item -Path license.md -Destination (Join-Path $dest 'LICENSE.md') -Force
      - name: Upload artifact
        if: steps.check_releases.outputs.skip_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: autogitpull-${{ matrix.name }}
          path: dist/${{ matrix.name }}/*

      - name: Get next rolling tag
        if: steps.check_releases.outputs.skip_build != 'true'
        id: rolling_tag
        run: |
          TODAY=$(date +'%Y.%m.%d')
          git fetch --tags
          LAST=$(git tag --list "${TODAY}-*" | grep -E "^${TODAY}-[0-9]+$" | sed "s/^${TODAY}-//" | sort -n | tail -1)
          if [ -z "$LAST" ]; then
            NEXT="${TODAY}-1"
          else
            NEXT_NUM=$((LAST + 1))
            NEXT="${TODAY}-${NEXT_NUM}"
          fi
          echo "NEXT_TAG=$NEXT" >> $GITHUB_ENV
          echo "Rolling tag: $NEXT"

      - name: Tag commit
        if: steps.check_releases.outputs.skip_build != 'true'
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag "$NEXT_TAG"
          git push origin "$NEXT_TAG"

  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    needs: build-test-release
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEXT_TAG }}
          name: Rolling Release ${{ env.NEXT_TAG }}
          body: Automated rolling release for ${{ env.NEXT_TAG }}
          draft: false
          prerelease: true
          files: |
            dist/**/autogitpull*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
